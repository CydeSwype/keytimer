<script>

var start_timer_seconds = 120;
var current_timer

var timer_complete_interval
var interval
var timer_paused
var timer_is_complete = 0
var input_minutes = ''
var timer_complete_count = 0

var default_background_color = ''
var default_foreground_color = 'rgb(0,0,0)'
var alt_background_color = 'rgb(255, 0, 0)'
var alt_foreground_color = 'rgb(100, 100, 100)'

function toggle_colors(target, prop, color1, color2){
    current_val = document.querySelector(target).style[prop]

    //console.log('current_val is', current_val)
    if (current_val != color1){
        document.querySelector(target).style[prop] = color1
    } else {
        document.querySelector(target).style[prop] = color2
    }
}

function update_fill(){
    var percent = 1 - current_timer / start_timer_seconds
    document.querySelector('#fill').style['width'] = percent * 100 + '%'
    if (percent == 1){
        document.querySelector('#fill').style['display'] = 'none'
    } else {
        document.querySelector('#fill').style['display'] = 'block'
    }
}

function timer_complete(){
    clearInterval(interval)
    timer_is_complete = 1

    if (play_audio_on_complete){
        var audio = new Audio('ding.mp3');
        audio.play();
    }

    timer_complete_interval = setInterval(function(){
        toggle_colors('#timer', 'background', alt_background_color, default_foreground_color)
        toggle_colors('#timer-value', 'color', default_background_color, alt_foreground_color)
        if (timer_complete_count % 2 == 0){
            document.title = '-----'
        } else {
            document.title = 'DONE!'
        }
        timer_complete_count++
    }, 1000)
}

function str_pad_left(string,pad,length) {
    return (new Array(length+1).join(pad)+string).slice(-length);
}

function format_time(seconds){
    var minutes = Math.floor(seconds / 60)
    var seconds_remaining = seconds % 60
    var final_time = str_pad_left(minutes,'0',2) + ':' + str_pad_left(seconds_remaining,'0',2);
    return final_time
}

function set_timer(minutes){
    start_timer_seconds = minutes * 60
    current_timer = start_timer_seconds
    start_timer()
    timer_is_complete = 0
}

function reset_and_restart_timer(){
    reset_timer()
    start_timer()
}

function reset_timer(){
    clearInterval(timer_complete_interval)
    clearInterval(interval)

    document.querySelector('#timer').style['background'] = default_background_color
    document.querySelector('#timer-value').style['color'] = default_foreground_color

    current_timer = start_timer_seconds
    update_timer(current_timer)
    timer_is_complete = 0
}

function show_input_minutes(){
    document.querySelector('#input-minutes').innerHTML = input_minutes + ' mins'
    document.querySelector('#input-minutes').style.display = 'flex'
}

function open_config(){
    // store the window size and location so we can restore it after the user is done with the config view
    window_height = window.innerHeight
    window_width = window.innerWidth
    window_x = window.screenLeft
    window_y = window.screenTop

    // resize the window
    var width = 340
    var height = 400
    window.resizeTo(width, height);

    // show the config div
    document.querySelector('#config').style.display = 'block'

    config_is_showing = 1
}

function close_config(){
    console.log('close the config')

    // save the config data
    save_config()

    // hide the config div
    document.querySelector('#config').style.display = 'none'

    // retrieve the stored, previous window size an x/y and restore the window to this size
    window.resizeTo(window_width, window_height)
    window.moveTo(window_x, window_y)

    config_is_showing = 0
}

function catch_keypress(e){
    // reset current timer
    if (e.key == 'r'){
        reset_and_restart_timer()
    }

    // pause current timer
    if (e.key == 'p' || e.code === 'Space'){
        if (timer_paused){
            start_timer()
        } else {
            pause_timer()
        }
    }

    // start new timer
    if (e.key == 'Enter' || e.key == 'Return'){
        set_timer(input_minutes)
        reset_and_restart_timer()
        document.querySelector('#input-minutes').style.display = 'none'
        input_minutes = ''
    }

    // set new timer
    var set_timer_keys = ['0','1','2','3','4','5','6','7','8','9']
    if (set_timer_keys.indexOf(e.key) != -1){
        //console.log('set timer key ', e.key)
        //pause_timer();
        clearInterval(interval)
        input_minutes += e.key
        show_input_minutes()
    }

    // set test timer
    if (e.key == '^'){
        clearInterval(interval)
        input_minutes += 0.1
        show_input_minutes()
    }

    // toggle config mode
    var open_config_keys = ['?']
    if (open_config_keys.indexOf(e.key) != -1){
        console.log('enter config mode')
        if (config_is_showing){
            close_config()
        } else {
            open_config()
        }
    }

    console.log(e.key)
    e.preventDefault();
}

function update_timer(seconds){
    var timer_value = document.getElementById('timer-value')
    timer_value.innerHTML = format_time(seconds)
    document.title = format_time(seconds)
    update_fill()
}

function countdown(){
    if (current_timer === 0){
        timer_complete()
        return
    }
    if (!current_timer){
        current_timer = start_timer_seconds
    }
    current_timer--
    update_timer(current_timer)
//    console.log(current_timer, timer_value)
}

function start_timer(){
    clearInterval(interval)
    interval = setInterval(function(){
        countdown()
    }, 1000);
    document.querySelector('#paused-message').style.display = 'none'
    timer_paused = false
}

function pause_timer(){
    clearInterval(interval)
    document.querySelector('#paused-message').style.display = 'flex'
    timer_paused = true

    // if the timer has completed and user pauses it, assume they want to reset it as well
    if (timer_is_complete == 1){
        reset_timer()
    }
}

function toggle_audio(audio_checkbox){
    if (audio_checkbox.checked == true){
        play_audio_on_complete = true
    } else {
        play_audio_on_complete = false
    }
}

function change_bgcolor(color_input){
    var new_color = color_input.value
    if (new_color.length > 0 && new_color.length <= 7 && new_color.substring(0, 1) == '#'){
        document.getElementById('fill').style.background = new_color
    }
}

function restore_config(){
    // read data from localstorage and restore form values
    var config = JSON.parse(localStorage.getItem('config'))
    console.log(config)

    // set the HTML values and then hit each of the methods to read
    document.getElementById('config_ding').checked = config['ding']
    document.getElementById('config_bgcolor').value = config['bgcolor']
    toggle_audio(document.getElementById('config_ding'))
    change_bgcolor(document.getElementById('config_bgcolor'))
}

function save_config(){
    // cycle through form elements and save the values to localstorage
    var config_data = {}
    document.querySelectorAll('.config_el').forEach(function (o){
        if (o.type == 'checkbox'){
            config_data[o.name] = o.checked
        } else {
            config_data[o.name] = o.value
        }
    })

    // store the combined data
    localStorage.setItem('config', JSON.stringify(config_data))
}

var window_height = window.innerHeight
var window_width = window.innerWidth
var window_x = window.screenLeft
var window_y = window.screenTop
var config_is_showing = 0
var play_audio_on_complete = 1

</script>

<style>
body {margin:0; padding:0; overflow: hidden;}

#input-minutes, #paused-message {
    display: none;
    text-align: center;
    background: #000;
    color: #fff;
    opacity: .8;
    font-size: min(25vw, 25vh);
}

#fill {
    background: #c63; 
    position: fixed; 
    height: 100%; 
    width: 0%; 
    z-index: -1;
}

#config {
    display: none;
    z-index: 4;
    width: 100%;
    height: 100%;
    padding:10px;
}

svg {
    width: 100%;
    height: auto;
}

.center {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  border: 0px solid green;
  overflow: hidden;
}

.button {
    padding: 10px 40px;
    font-size: 20px;
    background: #5A6;
    color: #fff;
    border-radius: 6px;
    display: inline-block;
    border: solid 1px #ccc;
}

.timer-value-container {
    font-size: min(35vw, 35vh);
}
</style>

<body id="body" style="background:#fff">
<div id="config">
    <div>Ding on timer complete: <input type="checkbox" class="checkbox config_el" name="ding" checked="true" id="config_ding" onchange="toggle_audio(this)"/></div>
    <div>Timer background color: <input type="color" class="config_el" name="bgcolor" value="#cc6633" id="config_bgcolor" onchange="change_bgcolor(this)"/></div>
    <div style="text-align:center; margin-top:10px"><input type="button" class="button" value="SAVE" onclick="close_config()"/></div>
</div>
<div id="timer">
    <div id="fill"></div>
    <div id="input-minutes" class="center"></div>
    <div id="paused-message" class="center">PAUSED</div>
    <div class="center timer-value-container">
        <span id="timer-value" style="color:#000">---</span>
    </div>
</div>
</body>

<script>
start_timer()
document.onkeypress = function(e) {catch_keypress(e)};
restore_config();
</script>